<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng d·ª•ng Qu·∫£n l√Ω Kh√°ch h√†ng</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: red;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        h2 {
            text-align: center;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            overflow: hidden;
            position: relative;
            min-width: 50px;
            min-height: 30px;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 5px;
            margin: 5px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        button {
            background-color: blue;
            color: white;
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.3);
        }
        button:active {
            transform: scale(0.98);
            box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
        }
        .ordered {
            background-color: #90EE90;
        }
        .medicine-ordered {
            background-color: orange;
        }
        .resizer {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 10px;
            height: 10px;
            background: rgba(0, 0, 0, 0.1);
            cursor: se-resize;
            z-index: 1000;
        }
        .column-resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            cursor: col-resize;
            z-index: 1000;
        }
        .resizing {
            user-select: none;
        }
        #customerTable th:first-child,
        #customerTable td:first-child {
            width: 50px;
        }
        .guide-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 900px;
            height: 900px;
            background-color: white;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            overflow: auto;
        }
        .popup-content {
            margin-bottom: 20px;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
        }
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: #ccc;
            cursor: se-resize;
        }
        #declarationForm {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #declarationForm input {
            flex: 1;
            margin-right: 10px;
        }
        textarea {
            resize: both;
            min-height: 50px;
        }
        .group-header {
            background-color: #f0f0f0 !important;
            font-weight: bold;
            padding: 10px !important;
        }
        #warningPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1001;
        }
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #ffeeba;
            padding-bottom: 10px;
        }
        .timer-display {
            background-color: #856404;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
        }
        .firebase-status {
            padding: 5px 10px;
            border-radius: 4px;
            margin-left: 10px;
            font-weight: bold;
        }
        .firebase-connected {
            background-color: #4CAF50;
            color: white;
        }
        .firebase-disconnected {
            background-color: #f44336;
            color: white;
        }
        .firebase-syncing {
            background-color: #ff9800;
            color: white;
        }
        .control-panel {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .stats-panel {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>QU·∫¢N L√ù KH√ÅCH H√ÄNG TRONG K·ª≤ <span id="firebaseStatus" class="firebase-status firebase-disconnected">ƒêang k·∫øt n·ªëi...</span></h1>
    
    <h2>M·ª•c ti√™u t·ªâ l·ªá KH ƒë·∫∑t h√†ng > 80% t·ªïng kh√°ch h√†ng qu·∫£n l√Ω/th√°ng</h2>
    
    <div class="control-panel">
        <form id="declarationForm">
            <input type="text" id="fullName" placeholder="H·ªç t√™n (d√πng ƒë·ªÉ xem th·ªëng k√™)" required>
            <input type="text" id="department" placeholder="B·ªô ph·∫≠n" required>
            <input type="date" id="date" required>
        </form>
        
        <div style="margin-top: 10px;">
            <button onclick="assignStaff()" style="background-color: #4CAF50; color: white;">Giao Ph·ª• Tr√°ch</button>
            <button class="guide-button" onclick="showGuide()">H∆∞·ªõng d·∫´n</button>
            <button onclick="showVideoPopup()">H∆∞·ªõng d·∫´n video</button>
        </div>
    </div>

    <div id="videoPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:1000px; height:600px; background:white; box-shadow:0 4px 8px rgba(0,0,0,0.2); border-radius:10px; z-index:1000; overflow:hidden; resize:both;">
        <iframe id="videoFrame" src="https://www.youtube.com/embed/iK-iDa32Bh8" style="width:100%; height:100%; border:none;"></iframe>
        <button onclick="closeVideoPopup()" style="position:absolute; top:10px; right:10px; background:red; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; font-size:18px;">&times;</button>
    </div>
    <div id="popupOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;" onclick="closeVideoPopup()"></div>

    <div class="control-panel">
        <h2>Qu·∫£n l√Ω Kh√°ch h√†ng</h2>
        
        <div style="margin-bottom: 10px;">
            <button onclick="addNewCustomer()">Th√™m m·ªõi</button>
            <input type="file" id="fileUpload" accept=".xlsx, .xls">
            <button onclick="uploadExcel()">Upload Excel DSKH</button>
            <button onclick="syncData()">ƒê·ªìng b·ªô</button>
            <input type="file" id="updateFileUpload" accept=".xlsx, .xls">
            <button onclick="updateData()">C·∫≠p nh·∫≠t DSKH excel</button>
        </div>
        
        <div style="margin-bottom: 10px;">
            <button onclick="saveJSON()">L∆∞u JSON</button>
            <input type="file" id="jsonFileUpload" accept=".json">
            <button onclick="openJSON()">M·ªü JSON</button>
            <button onclick="reloadExcel()">T·∫£i l·∫°i Excel</button>
            <button onclick="exportExcel()">Xu·∫•t Excel</button>
        </div>
        
        <div style="margin-bottom: 10px;">
            <label for="appKeyInput" style="font-weight: bold; margin-right: 10px;">M√£ ·ª©ng d·ª•ng:</label>
            <input type="text" id="appKeyInput" placeholder="VD: app1" style="
                width: 150px;
                padding: 5px;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            ">
            <button onclick="saveToLocalStorage(document.getElementById('appKeyInput').value)">L∆∞u d·ªØ li·ªáu</button>
            <button onclick="loadFromLocalStorage(document.getElementById('appKeyInput').value)">T·∫£i d·ªØ li·ªáu</button>
        </div>
        
        <div style="margin-bottom: 10px;">
            <button onclick="saveToFirebase()">L∆∞u l√™n Firebase</button>
            <button onclick="loadFromFirebase()">T·∫£i t·ª´ Firebase</button>
            <button onclick="deleteFromFirebase()" style="background-color: #f44336; color: white;">X√≥a d·ªØ li·ªáu Firebase</button>
            
            <button onclick="showSortPopup()">S·∫Øp x·∫øp</button>
            <button onclick="exportHTML()">Xu·∫•t file HTML quy ƒë·ªãnh</button>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm chung...">
            <button onclick="searchCustomers()">T√¨m</button>
            <input type="text" id="staffSearchInput" placeholder="T√™n nh√¢n vi√™n ph·ª• tr√°ch...">
            <button onclick="searchByStaff()">T√¨m theo NV</button>
            <button onclick="hideRows()">·∫®n h√†ng ch·ªçn</button>
            <button onclick="unhideRows()">Kh√¥ng ·∫©n</button>
            <button onclick="openStaffSelection()">Ch·ªçn nh√¢n vi√™n ƒë·ªÉ ·∫©n</button>
            <button onclick="resetData()" style="background-color: orange; color: white; padding: 10px; margin: 5px; font-weight: bold;">Refresh d·ªØ li·ªáu</button>
        </div>
        
        <div style="margin-top: 10px;">
            <input type="file" id="orderUpdateFile" accept=".xlsx, .xls" style="margin-top: 10px;">
            <button onclick="updateOrderData()" style="background-color: blue; color: white; padding: 10px; margin: 5px; font-weight: bold;">Up file ƒë∆°n h√†ng trong k·ª≥</button>
        </div>
    </div>

    <table id="customerTable">
        <thead>
            <tr>
                <th>Ch·ªçn</th>
                <th>STT</th>
                <th>M√É</th>
                <th>Kh√°ch h√†ng</th>
                <th>Ng∆∞·ªùi li√™n h·ªá</th>
                <th>ƒêi·ªán tho·∫°i</th>
                <th>Email</th>
                <th>Khu v·ª±c</th>
                <th>ƒê·ªãa ch·ªâ</th>
                <th>Nh√¢n vi√™n ph·ª• tr√°ch</th>
                <th>ƒê·∫∑t h√†ng non-drugs</th>
                <th>ƒê·∫∑t h√†ng thu·ªëc</th>
                <th>B√°o c√°o - ghi ch√∫ giao d·ªãch</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="stats" class="stats-panel"></div>

    <div id="guidePopup" class="popup">
        <div class="popup-content">
           <h2>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h2>
			<p style="line-height: 1.8;">
			<strong><u>B∆∞·ªõc 1:</u></strong><br>
			C·∫•p qu·∫£n l√Ω s·∫Ω qu·∫£n l√Ω d·ªØ li·ªáu ƒë·ªÉ up l√™n d·ª©ng d·ª•ng n√†y t·ª´ vi·ªác ch·ªçn k·ª≥ t·ª© ng√†y 1-1-2023 ƒë·∫øn n√†y, xu·∫•t file excel t·ª´ ERP-DANH S√ÅCH KH√ÅCH KH√ÅNG.<br>
			Sau ƒë√≥, file excel n√†y s·∫Ω ƒë∆∞·ª£c b·ªè c√°c ti√™u ƒë·ªÅ ph·ª• ch·ªâ ch·ª´a l·∫°i d·ªØ li·ªáu theo c·∫•u tr√∫c khung c·ªßa ·ª©ng d·ª•ng n√†y g·ªìm:<br>
			*STT	M√É	- Kh√°ch h√†ng -	Ng∆∞·ªùi li√™n h·ªá	ƒêi·ªán tho·∫°i	- Email	Khu v·ª±c	 - ƒê·ªãa ch·ªâ -	Nh√¢n vi√™n ph·ª• tr√°ch <br>
			*Sau ƒë√≥, c√≥ th·ªÉ nh√≥m theo ·ª©ng ƒë·ªëi t∆∞·ª£ng : Nh√† Thu·ªëc - c√¥ng ty d∆∞·ª£c- chu·ªói - b√°n l·∫ª -ctv ; hay nh√≥m theo khu v·ª±c kh√°ch h√†ng ƒëi·ªÅu ƒë∆∞·ª£c<br>
			*( Ch√∫ √Ω lo·∫°i b·ªï kh√°ch h√†ng kh√¥ng h·ª£p t√°c- chu·ªói NT l·ªùi l·ªõn ra)<br>
			* Up file ƒë√£ s·∫Øp x·∫øp l√™n ·ª©ng d·ª•ng ERP qu·∫£n l√Ω kh√°ch h√†ng n√†y- ch·ªçn ƒë·ªìng b·ªô ƒë·ªÉ file load l√™n h·∫øt - sau ƒë√≥ b·∫•m l∆∞u file json l·∫°i ƒë·ªÉ L∆∞u<br>
			* File n√†y l√† file ƒë·ªëi ch·ª©ng ƒë·ªãnh k·ª≥ cu·ªëi th√†ng c·∫≠p nh·∫≠t 1 l·∫ßn l·∫°i- c√°ch c·∫≠p nh·∫≠t l√† ch·ªâ c·∫ßn th√™m m√£ kh√°ch h√†ng t√™n , ƒë·ªãa ch·ªâ- khu v·ª±c- nh√¢n vi√™n ph·ª• tr√°ch;
			sau ƒë√≥ b·∫•m l∆∞u<br>
			<strong><u>B∆∞·ªõc 2: </u></strong><br>
			*Ph√¢n b·ªï t√™n nh√¢n ph·ª• tr√°ch v√†o - l√∫c n√†y t√πy theo b√†n b·∫°c BGƒê hay ƒë·ªÅ xu·∫•t , ng∆∞·ªùi qu·∫£n l√Ω s·∫Ω ƒëi·ªÅn t√™n nh√¢n vi√™n v√†o kh√°ch h√†ng m√† mu·ªën giao<br>
			*Khi ƒëi·ªÅn t√™n nh√¢n xong, th√¨ nh·ªõ b·∫•m l∆∞u file json ƒë·ªÉ l∆∞u t√™n h·ªç l·∫°i- file n√†y d√πng chia s·∫Ω cho BGƒê ƒë·ªÉ xem ƒë·ªìng b·ªô v√† ƒë·ªÉ g·ªüi cho nh√¢n vi√™n sau n√†y.<br>
			<strong><u>B∆∞·ªõc 3:</u></strong><br>
			Nh√¢n vi√™n m·ªü m√°y t√≠nh v√†o: khai t√™n trong form tr√πng v·ªõi t√™n trong d·ªØ li·ªáu th√¨ l√∫c ƒë√≥ s·∫Ω ch·∫°y th·ªëng k√™ s·ªë li·ªáu ƒë∆∞·ª£c.<br>
			ƒê·ªÉ ch·∫°y s·ªë li·ªáu do m√°y m√¨nh khai b√°o, th√¨ ph·∫£i b·∫•m ƒë·ªìng b·ªô l·∫°i m·ªôt l·∫ßn n·ªØa. C√°c em c√≥ th·ªÉ l·ªçc ri√™ng t√™n c·ªßa m√¨nh ph·ª• tr√°ch ƒë·ªÉ theo d√µi cho ti·ªán<br>
						
		            1. ƒê√¢y l√† m·ªôt trong n·ªôi dung b·∫Øt bu·ªôt t·∫•t c·∫£ nh√¢n vi√™n kinh doanh ph·∫£i qu·∫£n l√Ω v√† khai b√°o thay cho b√°o c√°o cu·ªëi k·ª≥.<br>
			2. Vi·ªác th·ª±c hi·ªán t·ªët gi√∫p ki·ªÉm so√°t hi·ªáu qu·∫£ x√∫c ti·∫øn- chƒÉm s√≥c kh√°ch h√†ng trong k·ª≥ v√† tƒÉng doanh thu , t·∫°o tƒÉng tr∆∞·ªüng.<br>
			3. D·ªØ li·ªáu file excel ƒë·ªÉ ƒë·ªìng b·ªô l√™n ·ª©ng d·ª•ng c·∫ßn qu·∫£n l√Ω theo d√µi trong k·ª≥, l√†m cƒÉn c·ª© ƒë√°nh gi√° k·ª≥ tr∆∞·ªõc so v·ªõi ·ª≥ sau.<br>
			<strong>4. L∆∞u √Ω: Sau m·ªói cu·ªëi th√°ng, em ph·∫£i xu·∫•t ra file excel l∆∞u l·∫°i danh s√°ch m·ªõi ƒë·ªÉ upload l·∫°i cho k·ª≥ ƒë·∫ßu th√°ng t·ªõi ( nh·ªõ d√πng ƒë√∫ng m·∫´u file khi ƒë·ªìng b·ªô).</strong><br>
			<strong> * Ngo√†i ra c√≥ m·ªôt c√°ch kh√°c: l√† ƒë·∫ßu th√°ng sau khi khai ng√†y l·∫≠p, b·∫°n g·ªü b·ªè c√°c ch·ªçn m√†u ƒë·∫∑t h√†ng th√†ng qua c·ªßa kh√°ch h√†ng tr·ªü v·ªÅ tr·∫°ng th√°i tr·∫Øng h·∫øt- sau ƒë√≥ b·∫•m l∆∞u v√†o m√°y.</strong><br>
			<strong> * Danh s√°ch kh√°ch h√†ng cu·ªëi k·ª≥ ch·∫°y t·ª´ ƒë∆°n h√†ng ch·ªçn k·ª≥ ƒë√£ l·∫≠p k·ª≥ tr∆∞·ªõc, t·ª´ kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c c√¥ng ty giao, t·ª´ kh√°ch h√†ng n√™n th∆∞·ªùng xuy√™n c·∫≠p nh·∫≠t l·∫°i cu·ªëi k·ª≥.<br>
			5. D·ªØ li·ªáu file excel v·ªÅ kh√°ch h√†ng n√™n ƒë∆∞·ª£c qu·∫£n l√Ω, s·∫Øp x·∫øp theo t·ª´ng nh√≥m ƒë·ªëi t∆∞·ª£ng ph·ª• tr√°ch: nh√† thu·ªëc, ƒë·∫°i l√Ω ph√¢n ph·ªëi, chu·ªói NT hay kh√°c.</strong><br>
			6. ƒê·∫ßu ti√™n chu·∫©n b·ªã danh s√°ch kh√°ch h√†ng m√† c√¥ng ty ƒë√£ giao k·ªÉ c·∫£ kh√°ch h√†ng do c√° nh√¢n khai th√°c trong file excel theo form chung trong ·ª©ng d·ª•ng.<br>
			8. M·ªü file t·ª´ t·ª©ng d·ª•ng v√† ch·ªçn upload file excel ƒë·ªÉ ƒë·ªìng b·ªô d·ª± li·ªáu tr√™n ·ª©ng d·ª•ng ƒë·ªÉ qu·∫£n l√Ω.<br>
			8. Khi thao t√°c hay ƒëi·ªÅn th√¥ng tin xong nh·ªõ ph·∫£i b·∫•m l∆∞u file: c√≥ 2 d·∫°ng l∆∞u fiie: b·∫•m l∆∞u v√†o m√°y s·∫Ω l∆∞u d·ªØ li·ªáu trong m√°y ƒëang l√†m c·ªë ƒë·ªãnh;<br>
			     <span style="display: inline-block; text-indent: 20px;">- B·∫•m l∆∞u file c√≥ ƒëu·ªïi JSON v√† c·∫•t file v√†o trong th∆∞ m·ª•c tr√™n GOOGLE DRIVE ( gi·ªëng nh∆∞ t·ªß h·ªì s∆° chung 0, t·∫°o th·ª≠ m·ª•c t√™n m√¨nh, ti√™u ƒë·ªÅ v√† l∆∞u file.</span><br>
				 <span style="display: inline-block; text-indent: 20px;">- File JSON c√≥ th·ªÉ qua m√°y kh√°ch m·ªü ·ª©ng d·ª•ng v√† ch·ªçn file l√™n s·∫Ω m·ªü JSON khi ƒë√≥ n√≥ s·∫Ω ƒë·ªìng b·ªô d·ªØ li·ªáu ƒë√£ l√†m t·ª´ m√°y kh√°c v√† c√≥ th·ªÉ ch·ªânh s·ª≠a.</span><br>
				 <span style="display: inline-block; text-indent: 20px;">- L∆∞u khi khi l√†m xong nh·ªõ b·∫•m l∆∞u file hay l∆∞u file json ƒë·ªÉ b·∫£o l∆∞u d·ªØ li·ªáu cu·ªëi k·ª≥ b√°o c√°o.</span><br>
					 
			9. Ch·ª©c nƒÉng xu·∫•t file html d√πng ƒë·ªÉ thay b·∫£ng b√°o c√°o cu·ªëi k·ª≥- file html ƒë∆∞·ª£c g·ªüi trong c√°c k·ª≥ h·ª£p ƒë√°nh gi√° n·ªôi b·ªô kinh doanh trong tu·∫ßn, g·ªüi ƒë·∫øn c·∫•p qu·∫£n l√Ω.<br>
			   vi·ªác g·ªüi HTML thay cho b√°o c√°o- n√™n ƒë∆∞·ª£c l∆∞u t√™n file t·∫°i th·ªùi gian l∆∞u v√† g·ªüi ƒë·ªãnh k·ª≥ ƒë·∫øn c·∫•p qu·∫£n l√Ω v√† ban gi√°m ƒë·ªëc y√™u c·∫ßu trong tu·∫ßn, cu·ªëi th√°ng.<br>
			10. Qu·∫£n l√Ω kh√°ch h√†ng ƒë·∫∑t h√†ng trong k·ª≥ l√† th∆∞·ªõc ƒëo v√† ƒë√°nh gi√° k·∫øt qu·∫£ KPI trong k·ª≥ c·ªßa m√¨nh v√† t√≠nh ƒë·ªô tƒÉng tr∆∞·ªüng kh√°ch h√†ng.<br>
			11. Khi ph√°t tri·ªÉn kh√°ch h√†ng m·ªõi c√≥ ƒë·∫∑t h√†ng trong k·ª≥, nh√¢n vi√™n n√™n khai b√°o trong b·∫£ng n√†y sau khi ƒë√£ khai b√°o tr√™n ERP 
			   </p>
        </div>
        <span class="close-button" onclick="closeGuide()">&times;</span>
        <div class="resize-handle"></div>
    </div>

    <div id="sortPopup" class="popup">
        <div class="popup-content">
            <h3>S·∫Øp x·∫øp theo</h3>
            <select id="sortField">
                <option value="1">M√£</option>
                <option value="6">Khu v·ª±c</option>
                <option value="8">Nh√¢n vi√™n ph·ª• tr√°ch</option>
            </select>
            <button onclick="groupAndSortData()">Nh√≥m v√† s·∫Øp x·∫øp</button>
            <button onclick="closeSortPopup()">ƒê√≥ng</button>
        </div>
    </div>

    <div id="warningPopup">
        <div class="popup-header">
            <h3>C·∫£nh b√°o!</h3>
            <div class="timer-display">
                Th·ªùi gian hi·ªÉn th·ªã: <span id="countdown">8</span>s
            </div>
            <span class="close-button">&times;</span>
        </div>
        <div class="popup-content">
            <p>S·ªë kh√°ch h√†ng do em qu·∫£n l√Ω ƒë·∫∑t h√†ng c√≤n r·∫•t th·∫≠p- h√£y t·∫≠p trung h·∫øt m√¨nh t∆∞∆°ng t√°c<br>
			   ch·ªët ƒë∆°n h·ªç nhanh h∆°n- t·∫≠n d·ª•ng m·ªçi h·ªó tr·ª£- s·∫£n ph·∫©m m·ªõi- kh∆°i g·ª£i nhanh ƒë·ªÉ v·ªÅ m·ª•c ti√™u ƒë·∫∑t h√†ng.<br>
			   C·∫ßn nhanh ch√≥ng ki·ªÉm tra k·∫ø ho·∫°ch l·∫°i- ƒëi·ªÅu ph·ªëi kh√°ch h√†ng nhanh h∆°n.<br>
			Kinh nghi·ªám b√≠ quy·∫øt c√≥ ƒë∆°n : ƒë·ª´ng ch·ªâ h·ªèi thƒÉm h√†ng c≈© l√∫c ƒë·∫ßu c√¢u ti·∫øp xuc, m√† lu√¥n chu·∫©n b·ªã m·ªôt t√≠nh hu·ªëng m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu chia s·∫Ω<br>
			,xem ƒë∆°n h√†ng k·ª≥ tr∆∞·ªõc kh√°ch h√†ng ko l·∫•y s·∫£n ph·∫©m, hay s·∫£n ph·∫©m m·ªõi, th√¨ t·∫≠n d·ª•ng ƒë·ªÉ x√∫c ti·∫øp m·ªü r·ªông c∆° h·ªôi ch·ªët s·∫£n ph·∫©m m·ªõi b√™n c·∫°nh l√™n ƒë∆°n h√†ng s·∫£n><br>
			s·∫£n ph·∫©m hi·ªán t·∫°i. Em ph·∫£i ch·ªß ƒë√¥ng g·ª£i nhu c·∫ßu ƒë·∫∑t m·ª•c ti√™u ph·∫£i b√°n ƒë∆∞·ª£c m·ªôt c√°ch c√≥ th·ªÉn khi ƒë√£ n√≥i chuy√™n. <br>
			</p>
        </div>
        <div class="resize-handle"></div>
    </div>

    <div id="reminderOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1001;"></div>
    <div id="reminderPopup" class="popup" style="display:none; z-index: 1002; width: 600px; height: auto; max-height: 80vh; background-color: #ffffe0; border: 2px solid #f44336; padding: 0; border-radius: 8px;">
        <div class="popup-header" style="background-color: #f44336; color: white; padding: 10px 15px; border-radius: 6px 6px 0 0; margin: 0; border-bottom: none;">
            <h3 style="margin: 0; color: white; font-size: 18px;">üîî EM ∆†I ! SAO KH√îNG T∆Ø∆†NG T√ÅC KH√ÅCH H√ÄNG N√ÄY C√ì ƒê∆†N</h3>
        </div>
        <div class="popup-content" id="reminderContent" style="padding: 20px; max-height: calc(80vh - 120px); overflow-y: auto; margin-bottom: 0;">
            </div>
        <div style="text-align: center; padding: 15px; border-top: 1px solid #ddd; background-color: #f9f9f9; border-radius: 0 0 6px 6px;">
            <button onclick="closeReminderPopup()" style="background-color: #4CAF50; color: white; padding: 10px 20px; font-size: 16px;">ƒê√£ ƒë·ªçc</button>
        </div>
    </div>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDKNLLhisemYQJeCW8QCOwfbvVsvUur-60",
        authDomain: "quetbarcode-2361a.firebaseapp.com",
        databaseURL: "https://quetbarcode-2361a-default-rtdb.firebaseio.com",
        projectId: "quetbarcode-2361a",
        storageBucket: "quetbarcode-2361a.firebasestorage.app",
        messagingSenderId: "209619008657",
        appId: "1:209619008657:web:ee4af6f6ec567a1d745330",
        measurementId: "G-2TRYH9DYK5"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Firebase connection status
    firebase.database().ref('.info/connected').on('value', (snapshot) => {
        const statusElement = document.getElementById('firebaseStatus');
        if (snapshot.val() === true) {
            statusElement.textContent = 'ƒê√£ k·∫øt n·ªëi Firebase';
            statusElement.className = 'firebase-status firebase-connected';
        } else {
            statusElement.textContent = 'M·∫•t k·∫øt n·ªëi Firebase';
            statusElement.className = 'firebase-status firebase-disconnected';
        }
    });

    // Global variables
    let customers = [];
    let currentCustomerCode = 1;
    let hiddenRows = [];

    // Firebase functions
    function saveToFirebase() {
        try {
            const statusElement = document.getElementById('firebaseStatus');
            statusElement.textContent = 'ƒêang l∆∞u l√™n Firebase...';
            statusElement.className = 'firebase-status firebase-syncing';
            
            database.ref('customerManagement/customers').set(customers)
                .then(() => {
                    statusElement.textContent = 'ƒê√£ l∆∞u l√™n Firebase';
                    statusElement.className = 'firebase-status firebase-connected';
                    console.log('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u l√™n Firebase');
                    alert('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u l√™n Firebase th√†nh c√¥ng!');
                })
                .catch((error) => {
                    statusElement.textContent = 'L·ªói k·∫øt n·ªëi Firebase';
                    statusElement.className = 'firebase-status firebase-disconnected';
                    console.error('L·ªói khi l∆∞u d·ªØ li·ªáu l√™n Firebase:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu l√™n Firebase: ' + error.message);
                });
        } catch (error) {
            console.error('L·ªói khi l∆∞u d·ªØ li·ªáu l√™n Firebase:', error);
            alert('C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu l√™n Firebase: ' + error.message);
        }
    }

    function loadFromFirebase() {
        try {
            const statusElement = document.getElementById('firebaseStatus');
            statusElement.textContent = 'ƒêang t·∫£i t·ª´ Firebase...';
            statusElement.className = 'firebase-status firebase-syncing';
            
            database.ref('customerManagement/customers').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        customers = data;
                        currentCustomerCode = Math.max(...customers.map(c => {
                            const num = parseInt(c.code?.replace('KH', '') || '0');
                            return isNaN(num) ? 0 : num;
                        })) + 1;
                        renderTable();
                        statusElement.textContent = 'ƒê√£ t·∫£i t·ª´ Firebase';
                        statusElement.className = 'firebase-status firebase-connected';
                        alert('ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ Firebase th√†nh c√¥ng!');
                    } else {
                        statusElement.textContent = 'ƒê√£ k·∫øt n·ªëi Firebase';
                        statusElement.className = 'firebase-status firebase-connected';
                        alert('Kh√¥ng c√≥ d·ªØ li·ªáu tr√™n Firebase.');
                    }
                })
                .catch((error) => {
                    statusElement.textContent = 'L·ªói k·∫øt n·ªëi Firebase';
                    statusElement.className = 'firebase-status firebase-disconnected';
                    console.error('L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ Firebase:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu t·ª´ Firebase: ' + error.message);
                });
        } catch (error) {
            console.error('L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ Firebase:', error);
            alert('C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu t·ª´ Firebase: ' + error.message);
        }
    }

    // ================== THAY ƒê·ªîI ·ªû ƒê√ÇY ==================
    /**
     * Ch·ª©c nƒÉng m·ªõi: X√≥a to√†n b·ªô d·ªØ li·ªáu t·∫°i n√∫t 'customerManagement/customers' tr√™n Firebase.
     */
    function deleteFromFirebase() {
        // 1. Y√™u c·∫ßu x√°c nh·∫≠n t·ª´ ng∆∞·ªùi d√πng v√¨ ƒë√¢y l√† h√†nh ƒë·ªông nguy hi·ªÉm
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA TO√ÄN B·ªò d·ªØ li·ªáu kh√°ch h√†ng tr√™n Firebase kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
            return; // Ng∆∞·ªùi d√πng ƒë√£ h·ªßy
        }

        try {
            // 2. C·∫≠p nh·∫≠t tr·∫°ng th√°i giao di·ªán
            const statusElement = document.getElementById('firebaseStatus');
            statusElement.textContent = 'ƒêang x√≥a tr√™n Firebase...';
            statusElement.className = 'firebase-status firebase-syncing';
            
            // 3. G·ªçi h√†m .remove() ƒë·ªÉ x√≥a d·ªØ li·ªáu t·∫°i ƒë∆∞·ªùng d·∫´n
            database.ref('customerManagement/customers').remove()
                .then(() => {
                    // 4. X·ª≠ l√Ω khi th√†nh c√¥ng
                    statusElement.textContent = 'ƒê√£ x√≥a d·ªØ li·ªáu Firebase';
                    statusElement.className = 'firebase-status firebase-connected'; // Tr·ªü l·∫°i tr·∫°ng th√°i 'ƒë√£ k·∫øt n·ªëi'
                    console.log('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi Firebase');
                    alert('ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu tr√™n Firebase th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ upload file m·ªõi ngay b√¢y gi·ªù.');
                    
                    // Ghi ch√∫: Ch√∫ng t√¥i KH√îNG x√≥a d·ªØ li·ªáu 'customers' c·ª•c b·ªô
                    // ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ upload file m·ªõi (t·ª´ Excel ho·∫∑c JSON)
                    // ho·∫∑c l∆∞u d·ªØ li·ªáu c·ª•c b·ªô hi·ªán t·∫°i l√™n.
                })
                .catch((error) => {
                    // 5. X·ª≠ l√Ω khi th·∫•t b·∫°i
                    statusElement.textContent = 'L·ªói k·∫øt n·ªëi Firebase';
                    statusElement.className = 'firebase-status firebase-disconnected';
                    console.error('L·ªói khi x√≥a d·ªØ li·ªáu Firebase:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi x√≥a d·ªØ li·ªáu Firebase: ' + error.message);
                });
        } catch (error) {
            // 6. X·ª≠ l√Ω l·ªói ƒë·ªìng b·ªô (n·∫øu c√≥)
            console.error('L·ªói khi x√≥a d·ªØ li·ªáu Firebase:', error);
            alert('C√≥ l·ªói x·∫£y ra khi x√≥a d·ªØ li·ªáu Firebase: ' + error.message);
        }
    }
    // ================== K·∫æT TH√öC THAY ƒê·ªîI ==================


    // Auto-save to Firebase when data changes
    function autoSaveToFirebase() {
        // Only auto-save if we have customers data
        if (customers.length > 0) {
            setTimeout(() => {
                saveToFirebase();
            }, 1000);
        }
    }
    
    // ================== B·ªî SUNG M·ªöI THEO Y√äU C·∫¶U ==================
    /**
     * G√°n nh√¢n vi√™n ph·ª• tr√°ch (t·ª´ √¥ #fullName) cho c√°c kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c tick ch·ªçn.
     * Ch·ª©c nƒÉng n√†y ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh ngay c·∫£ khi b·∫£ng ƒë√£ ƒë∆∞·ª£c l·ªçc ho·∫∑c s·∫Øp x·∫øp.
     */
    function assignStaff() {
        // 1. L·∫•y t√™n nh√¢n vi√™n t·ª´ √¥ khai b√°o "H·ªç t√™n"
        const staffName = document.getElementById('fullName').value.trim();
        
        // 2. Ki·ªÉm tra xem t√™n c√≥ r·ªóng kh√¥ng
        if (!staffName) {
            alert('Vui l√≤ng nh·∫≠p t√™n nh√¢n vi√™n v√†o √¥ "H·ªç t√™n" tr∆∞·ªõc khi giao ph·ª• tr√°ch.');
            document.getElementById('fullName').focus(); // Focus v√†o √¥ t√™n ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p
            return;
        }

        // 3. L·∫•y t·∫•t c·∫£ c√°c h√†ng trong tbody
        const rows = document.querySelectorAll('#customerTable tbody tr');
        let customerCodesToUpdate = []; // M·∫£ng l∆∞u M√É KH c·ªßa c√°c h√†ng ƒë∆∞·ª£c ch·ªçn
        let assignedCount = 0;

        // 4. Duy·ªát qua c√°c h√†ng ƒë·ªÉ thu th·∫≠p M√É kh√°ch h√†ng ƒë∆∞·ª£c ch·ªçn
        rows.forEach((row) => {
            // L·∫•y checkbox ·ªü √¥ ƒë·∫ßu ti√™n (c·ªôt "Ch·ªçn")
            const checkbox = row.querySelector('td:first-child input[type="checkbox"]');
            
            // 5. N·∫øu checkbox ƒë∆∞·ª£c ch·ªçn
            if (checkbox && checkbox.checked) {
                // L·∫•y M√É KH t·ª´ √¥ th·ª© 3 (index 2) - c·ªôt "M√É"
                const codeInput = row.cells[2].querySelector('input[type="text"]');
                if (codeInput && codeInput.value) {
                    // Th√™m m√£ KH v√†o danh s√°ch c·∫ßn c·∫≠p nh·∫≠t
                    customerCodesToUpdate.push(codeInput.value);
                }
                
                // B·ªè ch·ªçn checkbox sau khi ƒë√£ l·∫•y th√¥ng tin
                checkbox.checked = false;
            }
        });

        // N·∫øu kh√¥ng c√≥ kh√°ch h√†ng n√†o ƒë∆∞·ª£c ch·ªçn, th√¥ng b√°o v√† d·ª´ng
        if (customerCodesToUpdate.length === 0) {
            alert('B·∫°n ch∆∞a ch·ªçn kh√°ch h√†ng n√†o ƒë·ªÉ giao (h√£y tick v√†o √¥ vu√¥ng ·ªü ƒë·∫ßu h√†ng).');
            return;
        }

        // 6. C·∫≠p nh·∫≠t m·∫£ng 'customers' (d·ªØ li·ªáu ngu·ªìn)
        customers.forEach(customer => {
            // N·∫øu m√£ KH c·ªßa customer n√†y n·∫±m trong danh s√°ch c·∫ßn c·∫≠p nh·∫≠t
            if (customerCodesToUpdate.includes(customer.code)) {
                customer.staff = staffName; // G√°n t√™n nh√¢n vi√™n m·ªõi
                assignedCount++;
            }
        });

        // 7. N·∫øu c√≥ s·ª± thay ƒë·ªïi, render l·∫°i b·∫£ng, l∆∞u v√† th√¥ng b√°o
        if (assignedCount > 0) {
            renderTable(); // V·∫Ω l·∫°i to√†n b·ªô b·∫£ng ƒë·ªÉ hi·ªÉn th·ªã t√™n nh√¢n vi√™n m·ªõi
            autoSaveToFirebase(); // T·ª± ƒë·ªông l∆∞u d·ªØ li·ªáu ƒë√£ thay ƒë·ªïi l√™n Firebase
            alert(`ƒê√£ giao ${assignedCount} kh√°ch h√†ng cho nh√¢n vi√™n "${staffName}".`);
        } else {
            // Tr∆∞·ªùng h·ª£p hi·∫øm: ƒë√£ ch·ªçn h√†ng nh∆∞ng m√£ KH kh√¥ng kh·ªõp
            alert('Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng t∆∞∆°ng ·ª©ng trong d·ªØ li·ªáu. H√£y th·ª≠ ƒë·ªìng b·ªô l·∫°i.');
        }
    }
    // ================== K·∫æT TH√öC B·ªî SUNG M·ªöI ==================


    // Customer management functions
    function addNewCustomer() {
        const newCustomer = {
            code: `KH${currentCustomerCode++}`,
            name: '',
            contact: '',
            phone: '',
            email: '',
            area: '',
            address: '',
            staff: '',
            ordered: false,
            medicineOrdered: false,
            note: ''
        };
        customers.push(newCustomer);
        renderTable();
        autoSaveToFirebase();
    }

    function renderTable() {
        const tbody = document.querySelector('#customerTable tbody');
        tbody.innerHTML = '';
        customers.forEach((customer, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox"></td>
                <td>${index + 1}<div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.code || ''}" onchange="updateCustomer(${index}, 'code', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.name || ''}" onchange="updateCustomer(${index}, 'name', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.contact || ''}" onchange="updateCustomer(${index}, 'contact', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.phone || ''}" onchange="updateCustomer(${index}, 'phone', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.email || ''}" onchange="updateCustomer(${index}, 'email', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.area || ''}" onchange="updateCustomer(${index}, 'area', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.address || ''}" onchange="updateCustomer(${index}, 'address', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.staff || ''}" onchange="updateCustomer(${index}, 'staff', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="checkbox" ${customer.ordered ? 'checked' : ''} onchange="updateCustomer(${index}, 'ordered', this.checked)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="checkbox" ${customer.medicineOrdered ? 'checked' : ''} onchange="updateCustomer(${index}, 'medicineOrdered', this.checked)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><textarea onchange="updateCustomer(${index}, 'note', this.value)">${customer.note || ''}</textarea><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><button onclick="deleteCustomer(${index})">X√≥a</button><div class="resizer"></div><div class="column-resizer"></div></td>
            `;
            if (customer.ordered) {
                tr.classList.add('ordered');
            }
            if (customer.medicineOrdered) {
                tr.classList.add('medicine-ordered');
            }
            tbody.appendChild(tr);
        });
        updateStats();
        setupResizers();
    }

    function updateCustomer(index, field, value) {
        customers[index][field] = value;
        if (field === 'ordered' || field === 'medicineOrdered') {
            renderTable();
            autoSaveToFirebase();
        } else {
            updateStats();
        }
    }

    function deleteCustomer(index) {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng n√†y?')) {
            customers.splice(index, 1);
            renderTable();
            autoSaveToFirebase();
        }
    }

    function updateStats() {
        const declaredStaff = document.getElementById('fullName').value.trim().toLowerCase();

        if (!declaredStaff) {
            document.getElementById('stats').innerHTML = `
                <span style="color: red">Vui l√≤ng khai b√°o h·ªç t√™n ƒë·ªÉ t√≠nh to√°n s·ªë li·ªáu</span>
            `;
            return;
        }

        // Filter customers by declared staff
        const staffCustomers = customers.filter(c => c.staff.toLowerCase().trim() === declaredStaff);
        const staffTotal = staffCustomers.length;

        // Count orders
        const staffOrdered = staffCustomers.filter(c => c.ordered || c.medicineOrdered).length;
        const staffMedicineOrdered = staffCustomers.filter(c => c.medicineOrdered).length;

        // Calculate rates
        const staffRate = staffTotal > 0 ? ((staffOrdered / staffTotal) * 100).toFixed(2) : 0;
        const staffMedicineRate = staffTotal > 0 ? ((staffMedicineOrdered / staffTotal) * 100).toFixed(2) : 0;

        // Display results
        document.getElementById('stats').innerHTML = `
            T·ªïng s·ªë kh√°ch h√†ng c·ªßa ${declaredStaff}: ${staffTotal}<br>
            S·ªë kh√°ch h√†ng ƒë√£ ƒë·∫∑t h√†ng: ${staffOrdered}<br>
            S·ªë kh√°ch h√†ng ƒë√£ ƒë·∫∑t h√†ng thu·ªëc: ${staffMedicineOrdered}<br>
            T·ªâ l·ªá ƒë·∫∑t h√†ng t·ªïng th·ªÉ: ${staffRate}%<br>
            T·ªâ l·ªá ƒë·∫∑t h√†ng thu·ªëc: ${staffMedicineRate}%
        `;
    }

    // Excel functions
    function uploadExcel() {
        const fileInput = document.getElementById('fileUpload');
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        raw: false,
                        defval: "",
                        header: ["STT", "M√É", "Kh√°ch h√†ng", "Ng∆∞·ªùi li√™n h·ªá", "ƒêi·ªán tho·∫°i", "Email", "Khu v·ª±c", "ƒê·ªãa ch·ªâ", "Nh√¢n vi√™n ph·ª• tr√°ch", "ƒê√£ ƒë·∫∑t h√†ng", "ƒê·∫∑t h√†ng thu·ªëc", "Ghi ch√∫"]
                    });

                    // Update customer list
                    customers = jsonData.map((row, index) => {
                        return {
                            code: row['M√É'] || `KH${index + 1}`,
                            name: row['Kh√°ch h√†ng'] || '',
                            contact: row['Ng∆∞·ªùi li√™n h·ªá'] || '',
                            phone: row['ƒêi·ªán tho·∫°i'] || '',
                            email: row['Email'] || '',
                            area: row['Khu v·ª±c'] || '',
                            address: row['ƒê·ªãa ch·ªâ'] || '',
                            staff: row['Nh√¢n vi√™n ph·ª• tr√°ch'] || '',
                            ordered: row['ƒê√£ ƒë·∫∑t h√†ng'] === 'C√≥',
                            medicineOrdered: row['ƒê·∫∑t h√†ng thu·ªëc'] === 'C√≥',
                            note: row['Ghi ch√∫'] || ''
                        };
                    });

                    // Ensure unique customer codes
                    currentCustomerCode = Math.max(...customers.map(c => parseInt(c.code.replace('KH', '')) || 0)) + 1;

                    renderTable();
                    autoSaveToFirebase();
                    alert('ƒê√£ t·∫£i l√™n v√† x·ª≠ l√Ω file Excel th√†nh c√¥ng!');
                } catch (error) {
                    console.error('L·ªói khi x·ª≠ l√Ω file Excel:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω file Excel. Vui l√≤ng ki·ªÉm tra l·∫°i.');
                }
            };
            reader.readAsArrayBuffer(file);
        } else {
            alert('Vui l√≤ng ch·ªçn m·ªôt file Excel ƒë·ªÉ t·∫£i l√™n.');
        }
    }

    function updateData() {
        const fileInput = document.getElementById('updateFileUpload');
        const file = fileInput.files[0];
        
        if (file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    const newData = XLSX.utils.sheet_to_json(worksheet, {
                        raw: false,
                        defval: "",
                        header: ["STT", "M√É", "Kh√°ch h√†ng", "Ng∆∞·ªùi li√™n h·ªá", "ƒêi·ªán tho·∫°i", "Email", "Khu v·ª±c", "ƒê·ªãa ch·ªâ", "Nh√¢n vi√™n ph·ª• tr√°ch", "ƒê√£ ƒë·∫∑t h√†ng", "ƒê·∫∑t h√†ng thu·ªëc", "Ghi ch√∫"]
                    });

                    newData.forEach(row => {
                        const newCustomer = {
                            code: row['M√É'],
                            name: row['Kh√°ch h√†ng'],
                            contact: row['Ng∆∞·ªùi li√™n h·ªá'],
                            phone: row['ƒêi·ªán tho·∫°i'],
                            email: row['Email'],
                            area: row['Khu v·ª±c'],
                            address: row['ƒê·ªãa ch·ªâ'],
                            staff: row['Nh√¢n vi√™n ph·ª• tr√°ch'],
                            ordered: row['ƒê√£ ƒë·∫∑t h√†ng'] === 'C√≥',
                            medicineOrdered: row['ƒê·∫∑t h√†ng thu·ªëc'] === 'C√≥',
                            note: row['Ghi ch√∫']
                        };

                        // Find duplicate record
                        const duplicateIndex = customers.findIndex(customer =>
                            customer.code === newCustomer.code &&
                            customer.name === newCustomer.name &&
                            customer.contact === newCustomer.contact &&
                            customer.phone === newCustomer.phone &&
                            customer.email === newCustomer.email &&
                            customer.area === newCustomer.area &&
                            customer.address === newCustomer.address &&
                            customer.staff === newCustomer.staff
                        );

                        if (duplicateIndex !== -1) {
                            const overwrite = confirm(`D·ªØ li·ªáu cho kh√°ch h√†ng "${newCustomer.name}" ƒë√£ t·ªìn t·∫°i. B·∫°n c√≥ mu·ªën ch√©p ƒë√® l√™n kh√¥ng?`);

                            if (overwrite) {
                                customers[duplicateIndex] = newCustomer;
                            } else {
                                customers.push(newCustomer);
                            }
                        } else {
                            customers.push(newCustomer);
                        }
                    });

                    renderTable();
                    autoSaveToFirebase();
                    alert('C·∫≠p nh·∫≠t d·ªØ li·ªáu th√†nh c√¥ng!');
                } catch (error) {
                    console.error('L·ªói khi x·ª≠ l√Ω file Excel:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t d·ªØ li·ªáu t·ª´ file Excel.');
                }
            };

            reader.readAsArrayBuffer(file);
        } else {
            alert('Vui l√≤ng ch·ªçn m·ªôt file Excel ƒë∆°n h√†ng ƒë·ªÉ c·∫≠p nh·∫≠t.');
        }
    }

    function updateOrderData() {
        const fileInput = document.getElementById('orderUpdateFile');
        const file = fileInput.files[0];

        if (!file) {
            alert('Vui l√≤ng ch·ªçn m·ªôt file Excel ƒê∆°n H√†ng ƒë·ªÉ c·∫≠p nh·∫≠t ƒë∆°n h√†ng.');
            return;
        }

        const reader = new FileReader();

        reader.onload = function (e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];

                // Read data from Excel file
                const newData = XLSX.utils.sheet_to_json(worksheet, {
                    raw: false,
                    defval: "",
                    header: ["STT", "M√£", "Ng√†y", "Kh√°ch h√†ng", "M√£ s·ªë thu·∫ø", "Nh√¢n vi√™n", "S·ªë l∆∞·ª£ng", "T·ªïng ti·ªÅn", "H√¨nh th·ª©c n·ª£", "S·ªë ti·ªÅn n·ª£", "H·∫°n thanh to√°n", "Thu h·ªô?", "K√Ω g·ª≠i?", "Thu·ªëc?", "H√≥a ƒë∆°n VAT m·ªôt ph·∫ßn?", "H√≥a ƒë∆°n VAT to√†n ph·∫ßn?", "Ghi ch√∫", "X√°c nh·∫≠n?", "Duy·ªát?", "Ng√†y h√≥a ƒë∆°n", "Ng√†y Xu·∫•t h√†ng"]
                });

                let updatesCount = 0;

                newData.forEach(row => {
                    const customerName = row["Kh√°ch h√†ng"]?.trim();
                    const invoiceDate = row["Ng√†y h√≥a ƒë∆°n"]; // L·∫•y gi√° tr·ªã c·ªôt T

                    if (!customerName) {
                        console.warn(`B·ªè qua d√≤ng thi·∫øu d·ªØ li·ªáu: ${JSON.stringify(row)}`);
                        return;
                    }

                    // Find customer in application list
                    const customer = customers.find(c =>
                        c.name?.trim().toLowerCase() === customerName.toLowerCase()
                    );

                    if (customer) {
                        // CH·ªà X·ª¨ L√ù N·∫æU C√ì NG√ÄY H√ìA ƒê∆†N
                        if (invoiceDate && invoiceDate.toString().trim() !== '') {
                            const isMedicineOrder = row["Thu·ªëc?"]?.toString().trim().toUpperCase() === "TRUE";

                            if (isMedicineOrder) {
                                // N·∫øu Thu·ªëc? = TRUE => Tick ƒê·∫∑t h√†ng thu·ªëc, b·ªè ƒê·∫∑t h√†ng non-drugs
                                customer.medicineOrdered = true;
                                customer.ordered = false;
                                console.log(`Tick ƒê·∫∑t h√†ng thu·ªëc cho kh√°ch h√†ng: ${customerName}`);
                            } else {
                                // N·∫øu Thu·ªëc? = FALSE => Tick ƒê·∫∑t h√†ng non-drugs, b·ªè ƒê·∫∑t h√†ng thu·ªëc
                                customer.ordered = true;
                                customer.medicineOrdered = false;
                                console.log(`Tick ƒê·∫∑t h√†ng non-drugs cho kh√°ch h√†ng: ${customerName}`);
                            }
                            updatesCount++;
                        } else {
                            console.log(`B·ªè qua kh√°ch h√†ng: ${customerName} v√¨ ch∆∞a c√≥ ng√†y h√≥a ƒë∆°n.`);
                        }
                    } else {
                        console.warn(`Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng: ${customerName}`);
                    }
                });

                // Update table interface
                renderTable();
                autoSaveToFirebase();
                alert(`C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng! S·ªë l∆∞·ª£ng kh√°ch h√†ng ƒë∆∞·ª£c c·∫≠p nh·∫≠t: ${updatesCount}`);
            } catch (error) {
                console.error('L·ªói khi x·ª≠ l√Ω file Excel:', error);
                alert('C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω file Excel. Vui l√≤ng ki·ªÉm tra l·∫°i.');
            }
        };

        reader.readAsArrayBuffer(file);
    }

    function exportHTML() {
        const fullName = document.getElementById('fullName').value.trim();
        const department = document.getElementById('department').value.trim();
        const date = document.getElementById('date').value || new Date().toISOString().split('T')[0];

        if (!fullName || !department) {
            alert("Vui l√≤ng khai b√°o ƒë·∫ßy ƒë·ªß H·ªç t√™n v√† B·ªô ph·∫≠n tr∆∞·ªõc khi xu·∫•t file.");
            return;
        }

        const fileName = `Baocaotheodoikhachhang-${department}-${date}.html`;

        let dataToExport = `
        <html>
            <head>
                <meta charset="UTF-8">
                <title>B√°o c√°o theo d√µi kh√°ch h√†ng</title>
                <style>
                    body { font-family: 'Arial', sans-serif; padding: 20px; background-color: #f9f9f9; color: #333; }
                    h1, h2 { text-align: center; color: #007bff; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #007bff; color: white; }
                    td { background-color: #f5f5f5; }
                    .metadata { margin-bottom: 20px; padding: 10px; background-color: #007bff; color: white; border-radius: 5px; }
                    .metadata p { margin: 0; }
                </style>
            </head>
            <body>
                <h1>B√°o c√°o theo d√µi kh√°ch h√†ng</h1>
                <div class="metadata">
                    <p><strong>Ng∆∞·ªùi l·∫≠p b√°o c√°o:</strong> ${fullName}</p>
                    <p><strong>B·ªô ph·∫≠n:</strong> ${department}</p>
                    <p><strong>Ng√†y l·∫≠p:</strong> ${date}</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>M√É</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>Ng∆∞·ªùi li√™n h·ªá</th>
                            <th>ƒêi·ªán tho·∫°i</th>
                            <th>Email</th>
                            <th>Khu v·ª±c</th>
                            <th>ƒê·ªãa ch·ªâ</th>
                            <th>Nh√¢n vi√™n ph·ª• tr√°ch</th>
                            <th>ƒê·∫∑t h√†ng non-drugs</th>
                            <th>ƒê·∫∑t h√†ng thu·ªëc</th>
                            <th>Ghi ch√∫</th>
                        </tr>
                    </thead>
                    <tbody>`;

        customers.forEach((customer, index) => {
            dataToExport += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${customer.code}</td>
                    <td>${customer.name}</td>
                    <td>${customer.contact}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email}</td>
                    <td>${customer.area}</td>
                    <td>${customer.address}</td>
                    <td>${customer.staff}</td>
                    <td>${customer.ordered ? "C√≥" : "Kh√¥ng"}</td>
                    <td>${customer.medicineOrdered ? "C√≥" : "Kh√¥ng"}</td>
                    <td>${customer.note}</td>
                </tr>`;
        });

        dataToExport += `
                    </tbody>
                </table>
            </body>
        </html>`;

        const blob = new Blob([dataToExport], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert(`ƒê√£ xu·∫•t file HTML: ${fileName}`);
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(customers.map(c => ({
            STT: c.code,
            M√É: c.code,
            "Kh√°ch h√†ng": c.name,
            "Ng∆∞·ªùi li√™n h·ªá": c.contact,
            "ƒêi·ªán tho·∫°i": c.phone,
            Email: c.email,
            "Khu v·ª±c": c.area,
            "ƒê·ªãa ch·ªâ": c.address,
            "Nh√¢n vi√™n ph·ª• tr√°ch": c.staff,
            "ƒê√£ ƒë·∫∑t h√†ng": c.ordered ? "TRUE" : "FALSE",
            "ƒê·∫∑t h√†ng thu·ªëc": c.medicineOrdered ? "TRUE" : "FALSE",
            "Ghi ch√∫": c.note
        })));

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Customers");

        const fullName = document.getElementById('fullName').value || 'unknown';
        const date = document.getElementById('date').value || new Date().toISOString().split('T')[0];
        const fileName = `${fullName}-dulieukh-${date}.xlsx`;

        XLSX.writeFile(wb, fileName);
    }

    function saveJSON() {
        try {
            const fullName = document.getElementById('fullName').value.trim();
            const department = document.getElementById('department').value.trim();
            const date = document.getElementById('date').value || new Date().toISOString().split('T')[0];

            if (!fullName || !department) {
                alert("Vui l√≤ng khai b√°o ƒë·∫ßy ƒë·ªß H·ªç t√™n v√† B·ªô ph·∫≠n tr∆∞·ªõc khi l∆∞u file.");
                return;
            }

            const fileName = `Baocaotheodoikhachhang-${department}-${date}.json`;

            const dataToSave = customers.map(customer => ({
                code: customer.code || '',
                name: customer.name || '',
                contact: customer.contact || '',
                phone: customer.phone || '',
                email: customer.email || '',
                area: customer.area || '',
                address: customer.address || '',
                staff: customer.staff || '',
                ordered: Boolean(customer.ordered),
                medicineOrdered: Boolean(customer.medicineOrdered),
                note: customer.note || ''
            }));

            const jsonString = JSON.stringify(dataToSave, null, 2);
            const blob = new Blob([jsonString], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert(`ƒê√£ l∆∞u file JSON: ${fileName}`);
        } catch (error) {
            console.error('L·ªói khi l∆∞u file JSON:', error);
            alert(`C√≥ l·ªói x·∫£y ra khi l∆∞u file JSON: ${error.message}`);
        }
    }

    function openJSON() {
        const fileInput = document.getElementById('jsonFileUpload');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Vui l√≤ng ch·ªçn m·ªôt file JSON ƒë·ªÉ t·∫£i l√™n.');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const jsonData = JSON.parse(e.target.result);
                customers = jsonData;
                currentCustomerCode = Math.max(...customers.map(c => {
                    const num = parseInt(c.code.replace('KH', ''));
                    return isNaN(num) ? 0 : num;
                })) + 1;
                renderTable();
                autoSaveToFirebase();
                alert('ƒê√£ t·∫£i l√™n v√† x·ª≠ l√Ω file JSON th√†nh c√¥ng!');
            } catch (error) {
                console.error('L·ªói khi x·ª≠ l√Ω file JSON:', error);
                alert(`C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω file JSON: ${error.message}`);
            }
        };
        reader.readAsText(file);
    }

    // Resize functions
    function setupResizers() {
        const table = document.getElementById('customerTable');
        const cols = table.querySelectorAll('th, td');

        cols.forEach(col => {
            const columnResizer = col.querySelector('.column-resizer');
            const cellResizer = col.querySelector('.resizer');

            if (columnResizer) {
                columnResizer.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    const startX = e.pageX;
                    const startWidth = col.offsetWidth;

                    function onMouseMove(e) {
                        const width = startWidth + (e.pageX - startX);
                        col.style.width = `${width}px`;
                    }

                    function onMouseUp() {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            }

            if (cellResizer) {
                cellResizer.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    const startX = e.pageX;
                    const startY = e.pageY;
                    const startWidth = col.offsetWidth;
                    const startHeight = col.offsetHeight;

                    function onMouseMove(e) {
                        const width = startWidth + (e.pageX - startX);
                        const height = startHeight + (e.pageY - startY);
                        col.style.width = `${width}px`;
                        col.style.height = `${height}px`;
                    }

                    function onMouseUp() {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            }
        });
    }

    // Other functions
    function syncData() {
        renderTable();
        alert("ƒê√£ ƒë·ªìng b·ªô d·ªØ li·ªáu.");
    }

    function reloadExcel() {
        renderTable();
        alert("ƒê√£ t·∫£i l·∫°i d·ªØ li·ªáu Excel.");
    }

    function saveToLocalStorage(appKey) {
        if (!appKey) {
            alert("Vui l√≤ng nh·∫≠p m√£ ·ª©ng d·ª•ng ƒë·ªÉ l∆∞u d·ªØ li·ªáu.");
            return;
        }
        localStorage.setItem(`data_${appKey}`, JSON.stringify(customers));
        alert(`D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u cho ·ª©ng d·ª•ng: ${appKey}`);
    }

    function loadFromLocalStorage(appKey) {
        if (!appKey) {
            alert("Vui l√≤ng nh·∫≠p m√£ ·ª©ng d·ª•ng ƒë·ªÉ t·∫£i d·ªØ li·ªáu.");
            return;
        }
        const savedData = localStorage.getItem(`data_${appKey}`);
        if (savedData) {
            customers = JSON.parse(savedData);
            renderTable();
            alert(`D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i cho ·ª©ng d·ª•ng: ${appKey}`);
        } else {
            alert(`Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho ·ª©ng d·ª•ng: ${appKey}`);
        }
    }

    // Popup functions
    function showGuide() {
        document.getElementById('guidePopup').style.display = 'block';
    }

    function closeGuide() {
        document.getElementById('guidePopup').style.display = 'none';
    }

    function showSortPopup() {
        document.getElementById('sortPopup').style.display = 'block';
    }

    function closeSortPopup() {
        document.getElementById('sortPopup').style.display = 'none';
    }

    function groupAndSortData() {
        const table = document.querySelector('#customerTable');
        const select = document.getElementById('sortField');
        const columnIndex = parseInt(select.value);
        
        // Clone customers array to not affect original data
        const groupedCustomers = [...customers];
        
        // Sort and group by selected field
        const groups = new Map();
        
        groupedCustomers.forEach(customer => {
            let key = '';
            switch(columnIndex) {
                case 1: key = customer.code || ''; break;
                case 6: key = customer.area || ''; break;
                case 8: key = customer.staff || ''; break;
            }
            
            if (!groups.has(key)) {
                groups.set(key, []);
            }
            groups.get(key).push(customer);
        });
        
        // Sort groups
        const sortedGroups = new Map([...groups.entries()].sort());
        
        // Update customers array with sorted order
        customers = [];
        sortedGroups.forEach((groupCustomers, groupKey) => {
            customers.push(...groupCustomers);
        });
        
        renderTable();
        closeSortPopup();
    }

    function searchCustomers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const tbody = document.querySelector('#customerTable tbody');
        
        tbody.innerHTML = '';

        customers
            .filter(customer => 
                customer.code.toLowerCase().includes(searchTerm) ||
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.area.toLowerCase().includes(searchTerm) ||
                customer.contact.toLowerCase().includes(searchTerm) ||
                customer.staff.toLowerCase().includes(searchTerm) ||
                (customer.ordered && "ƒë·∫∑t h√†ng".includes(searchTerm)) || 
                (customer.medicineOrdered && "ƒë·∫∑t h√†ng thu·ªëc".includes(searchTerm))
            )
            .forEach((customer, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox"></td>
                    <td>${index + 1}</td>
                    <td>${customer.code}</td>
                    <td>${customer.name}</td>
                    <td>${customer.contact}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email}</td>
                    <td>${customer.area}</td>
                    <td>${customer.address}</td>
                    <td>${customer.staff}</td>
                    <td>${customer.ordered ? 'C√≥' : 'Kh√¥ng'}</td>
                    <td>${customer.medicineOrdered ? 'C√≥' : 'Kh√¥ng'}</td>
                    <td>${customer.note}</td>
                    <td><button onclick="deleteCustomer(${index})">X√≥a</button></td>
                `;
                tbody.appendChild(tr);
            });
    }

    function searchByStaff() {
    // L·∫•y gi√° tr·ªã t√¨m ki·∫øm v√† chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng ƒë·ªÉ so s√°nh kh√¥ng ph√¢n bi·ªát hoa/th∆∞·ªùng
    const searchTerm = document.getElementById('staffSearchInput').value.toLowerCase().trim();
    
    // L·∫•y t·∫•t c·∫£ c√°c h√†ng (<tr>) trong ph·∫ßn th√¢n c·ªßa b·∫£ng (<tbody>)
    const rows = document.querySelectorAll('#customerTable tbody tr');

    // Duy·ªát qua t·ª´ng h√†ng ƒë·ªÉ quy·∫øt ƒë·ªãnh ·∫©n hay hi·ªán
    rows.forEach(row => {
        // L·∫•y √¥ (<td>) ch·ª©a t√™n nh√¢n vi√™n ph·ª• tr√°ch (c·ªôt th·ª© 10, ch·ªâ s·ªë 9)
        const staffCell = row.cells[9]; 
        
        if (staffCell) {
            // L·∫•y th·∫ª input b√™n trong √¥ ƒë√≥
            const staffInput = staffCell.querySelector('input[type="text"]');
            
            if (staffInput) {
                // L·∫•y gi√° tr·ªã t√™n nh√¢n vi√™n t·ª´ th·∫ª input
                const staffName = staffInput.value.toLowerCase().trim();

                // N·∫øu t√™n nh√¢n vi√™n ch·ª©a c·ª•m t·ª´ t√¨m ki·∫øm (ho·∫∑c n·∫øu √¥ t√¨m ki·∫øm r·ªóng)
                if (staffName.includes(searchTerm)) {
                    // Th√¨ hi·ªÉn th·ªã h√†ng n√†y
                    row.style.display = ''; 
                } else {
                    // Ng∆∞·ª£c l·∫°i, ·∫©n h√†ng n√†y ƒëi
                    row.style.display = 'none'; 
                }
            }
        }
    });
}

    function hideRows() {
        const rows = document.querySelectorAll('#customerTable tbody tr');
        hiddenRows = [];

        rows.forEach((row, index) => {
            const checkbox = row.querySelector('input[type="checkbox"]'); 
            if (checkbox && checkbox.checked) {
                hiddenRows.push(index);
                row.style.display = 'none';
            }
        });
    }

    function unhideRows() {
        const rows = document.querySelectorAll('#customerTable tbody tr');
        hiddenRows.forEach(index => {
            rows[index].style.display = '';
        });
        hiddenRows = [];
    }

    function resetData() {
        customers.forEach(customer => {
            customer.ordered = false;
            customer.medicineOrdered = false;
        });

        renderTable();
        autoSaveToFirebase();
        alert('T·∫•t c·∫£ c√°c l·ª±a ch·ªçn ƒë√£ ƒë∆∞·ª£c b·ªè ch·ªçn!');
    }

    function openStaffSelection() {
        const staffNamesInput = prompt("Nh·∫≠p danh s√°ch t√™n nh√¢n vi√™n ph·ª• tr√°ch, ngƒÉn c√°ch nhau b·∫±ng d·∫•u ph·∫©y:");
        if (staffNamesInput) {
            const staffNames = staffNamesInput.split(',').map(name => name.trim().toLowerCase());
            renderTable();
            autoSelectByStaff(staffNames);
        }
    }

    function autoSelectByStaff(staffNames) {
        const rows = document.querySelectorAll('#customerTable tbody tr');
        
        rows.forEach(row => {
            const staffCell = row.cells[9];
            const checkbox = row.querySelector('input[type="checkbox"]');
            
            if (staffCell && checkbox) {
                const staffText = staffCell.querySelector('input[type="text"]').value.trim().toLowerCase();
                if (staffNames.includes(staffText)) {
                    checkbox.checked = true;
                } else {
                    checkbox.checked = false;
                }
            }
        });
    }

    function showVideoPopup() {
        document.getElementById('videoPopup').style.display = 'block';
        document.getElementById('popupOverlay').style.display = 'block';
    }

    function closeVideoPopup() {
        document.getElementById('videoPopup').style.display = 'none';
        document.getElementById('popupOverlay').style.display = 'none';
    }

    // Warning functions
    function kiemTraTiLeDatHang() {
        const nhanVienKhaiBao = document.getElementById('fullName').value.trim().toLowerCase();

        if (!nhanVienKhaiBao) return;

        const khachHangPhuTrach = customers.filter(c => c.staff.toLowerCase().trim() === nhanVienKhaiBao);
        const tongKhachHang = khachHangPhuTrach.length;
        const khachHangDaDatHang = khachHangPhuTrach.filter(c => c.ordered).length;
        const tiLeDatHang = tongKhachHang > 0 ? (khachHangDaDatHang / tongKhachHang) * 100 : 0;

        if (tiLeDatHang < 50) {
            hienThongBaoCanhBao(`T·ª∑ l·ªá ƒë·∫∑t h√†ng c·ªßa b·∫°n l√† ${tiLeDatHang.toFixed(2)}%. H√£y c·∫£i thi·ªán ngay!`);
        }
    }

    function hienThongBaoCanhBao(noiDung) {
        const thongBaoPopup = document.getElementById('warningPopup');
        
        thongBaoPopup.querySelector('.popup-content').innerHTML = `<p>${noiDung}</p>`;
        thongBaoPopup.style.display = 'block';
        
        setTimeout(() => {
            thongBaoPopup.style.display = 'none';
        }, 6000);
    }

    // =======================================================
    // B·ªî SUNG M·ªöI: CH·ª®C NƒÇNG POPUP NH·∫ÆC NH·ªû
    // =======================================================

    /**
     * Hi·ªÉn th·ªã popup nh·∫Øc nh·ªü cho T·∫§T C·∫¢ nh√¢n vi√™n
     * c√≥ kh√°ch h√†ng ch∆∞a ƒë·∫∑t h√†ng, d·ª±a tr√™n d·ªØ li·ªáu 'customers'.
     * Kh√¥ng c√≤n ph·ª• thu·ªôc v√†o √¥ khai b√°o #fullName.
     */
    function showReminderPopup() {
        const reminderContent = document.getElementById('reminderContent');
        let htmlContent = '';
        let staffWithReminders = 0;

        // 1. L·∫•y t·∫•t c·∫£ t√™n nh√¢n vi√™n duy nh·∫•t t·ª´ d·ªØ li·ªáu (bi·∫øn 'customers' to√†n c·ª•c)
        const staffNames = [...new Set(customers.map(c => c.staff.trim()).filter(name => name))];
        
        if (staffNames.length === 0) {
            console.log("Kh√¥ng c√≥ nh√¢n vi√™n n√†o ƒë∆∞·ª£c g√°n trong d·ªØ li·ªáu, kh√¥ng hi·ªÉn th·ªã nh·∫Øc nh·ªü.");
            return;
        }

        // 2. L·∫∑p qua t·ª´ng nh√¢n vi√™n ƒë·ªÉ ki·ªÉm tra
        staffNames.forEach(staffName => {
            const staffNameLower = staffName.toLowerCase();
            
            // L·ªçc danh s√°ch kh√°ch h√†ng c·∫ßn nh·∫Øc cho nh√¢n vi√™n n√†y
            const customersToRemind = customers.filter(c => 
                c.staff.trim().toLowerCase() === staffNameLower && // ƒê√∫ng nh√¢n vi√™n
                !c.ordered &&                                    // Ch∆∞a ƒë·∫∑t non-drugs
                !c.medicineOrdered                               // Ch∆∞a ƒë·∫∑t thu·ªëc
            );

            // 3. N·∫øu nh√¢n vi√™n n√†y c√≥ kh√°ch h√†ng c·∫ßn nh·∫Øc, th√™m v√†o n·ªôi dung HTML
            if (customersToRemind.length > 0) {
                staffWithReminders++;
                
                // Th√™m ti√™u ƒë·ªÅ cho nh√¢n vi√™n
                htmlContent += `<div style="margin-top: ${staffWithReminders > 1 ? '20px' : '0'};">`;
                htmlContent += `<h4 style="color: #d9534f; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 15px; margin-bottom: 10px; font-size: 17px;">Nh√¢n vi√™n: ${staffName}</h4>`;
                htmlContent += `<p style="margin-top: 0; margin-bottom: 10px; font-size: 15px;">B·∫°n c√≤n <strong>${customersToRemind.length}</strong> kh√°ch h√†ng ch∆∞a ƒë·∫∑t h√†ng:</p>`;
                
                // Th√™m danh s√°ch kh√°ch h√†ng
                htmlContent += '<ul style="list-style-type: decimal; padding-left: 25px; margin: 0; max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding-top: 10px; padding-bottom: 10px; background: #fff;">';
                customersToRemind.forEach(c => {
                    htmlContent += `<li style="margin-bottom: 8px; font-size: 14px;"><strong>${c.name}</strong> (M√£: ${c.code})</li>`;
                });
                htmlContent += '</ul>';
                htmlContent += `</div>`;
            }
        });

        // 4. Ki·ªÉm tra xem c√≥ ai c·∫ßn nh·∫Øc kh√¥ng
        if (staffWithReminders > 0) {
            // C√≥, ch√®n HTML v√† hi·ªÉn th·ªã popup
            reminderContent.innerHTML = htmlContent;
            document.getElementById('reminderOverlay').style.display = 'block';
            document.getElementById('reminderPopup').style.display = 'block';
        } else {
            // Kh√¥ng, log ra console
            console.log("T·∫•t c·∫£ nh√¢n vi√™n ƒë·ªÅu ƒë√£ ho√†n th√†nh. T·ªët!");
        }
    }


    /**
     * ƒê√≥ng popup nh·∫Øc nh·ªü v√† l·ªõp ph·ªß.
     */
    function closeReminderPopup() {
        document.getElementById('reminderOverlay').style.display = 'none';
        document.getElementById('reminderPopup').style.display = 'none';
    }

    /**
     * // H√ÄM ƒê√É ƒê∆Ø·ª¢C CH·ªàNH S·ª¨A THEO C·∫§U TR√öC M·ªöI
     * Ki·ªÉm tra th·ªùi gian hi·ªán t·∫°i v√† k√≠ch ho·∫°t popup n·∫øu
     * ƒë√∫ng khung gi·ªù v√† ng√†y quy ƒë·ªãnh.
     */
    function checkAndTriggerReminder() {
        
        // --- C·∫§U H√åNH L·ªäCH TR√åNH POPUP THEO √ù B·∫†N ---
        // (B·∫°n c√≥ th·ªÉ d·ªÖ d√†ng th√™m/b·ªõt ng√†y v√† gi·ªù ·ªü ƒë√¢y)
        const popupSchedule = {
            // 0:CN, 1:T2, 2:T3, 3:T4, 4:T5, 5:T6, 6:T7
            days: [0, 1, 2, 3, 4, 5, 6], // Ch·∫°y t·∫•t c·∫£ c√°c ng√†y
            
            // C√°c m·ªëc th·ªùi gian
            times: [
                { hour: 9, minute: 0 },
                { hour: 11, minute: 15 }, // Gi·ªù test c·ªßa b·∫°n
                { hour: 14, minute: 0 },
                { hour: 15, minute: 0 }
            ]
        };
        // ---------------------------------------------

        const now = new Date();
        const dayOfWeek = now.getDay();
        const hour = now.getHours();
        const minute = now.getMinutes();
        
        // Ki·ªÉm tra xem popup ƒë√£ m·ªü ch∆∞a
        const popupIsOpen = document.getElementById('reminderPopup').style.display === 'block';
        
        // 1. Ki·ªÉm tra xem h√¥m nay c√≥ ph·∫£i ng√†y ch·∫°y kh√¥ng
        const isScheduledDay = popupSchedule.days.includes(dayOfWeek);

        if (isScheduledDay && !popupIsOpen) {
            // 2. N·∫øu ƒë√∫ng ng√†y, ki·ªÉm tra xem c√≥ ph·∫£i gi·ªù ch·∫°y kh√¥ng
            const isScheduledTime = popupSchedule.times.some(time => 
                time.hour === hour && time.minute === minute
            );
            
            // 3. N·∫øu ƒë√∫ng c·∫£ ng√†y v√† gi·ªù, k√≠ch ho·∫°t popup
            if (isScheduledTime) {
                console.log("ƒêang k√≠ch ho·∫°t popup nh·∫Øc nh·ªü t·ª± ƒë·ªông theo l·ªãch tr√¨nh...");
                showReminderPopup();
            }
        }
    }

    // =======================================================
    // K·∫æT TH√öC B·ªî SUNG M·ªöI
    // =======================================================


    // Initialize on load
    window.onload = function() {
        const appKey = localStorage.getItem('currentAppKey') || 'default';
        loadFromLocalStorage(appKey);
        
        // Load from Firebase on startup
        loadFromFirebase();
        
        // Set up periodic order rate check
        setInterval(kiemTraTiLeDatHang, 30000);

        // Ch·∫°y ki·ªÉm tra nh·∫Øc nh·ªü m·ªói ph√∫t (60000ms)
        setInterval(checkAndTriggerReminder, 60000);
    };

    // Popup resize handlers
    const popups = document.querySelectorAll('.popup');
    popups.forEach(popup => {
        const resizeHandle = popup.querySelector('.resize-handle');
        if (resizeHandle) {
            resizeHandle.addEventListener('mousedown', initResize, false);
        }
    });

    function initResize(e) {
        const popup = e.target.closest('.popup');
        window.addEventListener('mousemove', resize, false);
        window.addEventListener('mouseup', stopResize, false);

        function resize(e) {
            popup.style.width = (e.clientX - popup.offsetLeft) + 'px';
            popup.style.height = (e.clientY - popup.offsetTop) + 'px';
        }

        function stopResize() {
            window.removeEventListener('mousemove', resize, false);
            window.removeEventListener('mouseup', stopResize, false);
        }
    }
</script>
</body>
</html>
